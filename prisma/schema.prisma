generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}


model Producto {
  id               Int      @id @default(autoincrement())
  nombre           String
  slug             String   @unique
  descripcionCorta String?
  descripcionLarga String?
  categoria        String?
  precio           Float    // Mantener como "Precio base" o referencia
  imagen           String?
  stock            Int?     @default(0)
  activo           Boolean  @default(true)
  destacado        Boolean  @default(false)
  orden            Int      @default(0)
  creadoEn         DateTime @default(now())
  actualizadoEn    DateTime @updatedAt

  itemsPedido      PedidoItem[]
  categorias       ProductosCategorias[]
  
  //  NUEVO: Relaci贸n con presentaciones
  presentaciones   Presentacion[] 
}

model Presentacion {
  id         Int      @id @default(autoincrement())
  nombre     String   // Ej: "30ml", "60ml"
  precio     Float
  stock      Int      @default(0)
  productoId Int
  producto   Producto @relation(fields: [productoId], references: [id], onDelete: Cascade)
}
model Categoria {
  id    Int    @id @default(autoincrement())
  nombre String
  slug   String @unique

  productos ProductosCategorias[]
}

/// tabla puente expl铆cita para la relaci贸n N-a-N
model ProductosCategorias {
  productoId Int
  categoriaId Int

  producto  Producto  @relation(fields: [productoId], references: [id])
  categoria Categoria @relation(fields: [categoriaId], references: [id])

  @@id([productoId, categoriaId])
}


model User {
  id           Int      @id @default(autoincrement())
  nombre       String?  // Cambiado de name a nombre
  apellido     String?  // Agregado apellido
  email        String   @unique
  passwordHash String
  telefono     String?  // Agregado para que tambi茅n se autocomplete
  role         String   @default("USER")
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  pedidos Pedido[]
}

model Pedido {
  id          Int    @id @default(autoincrement())
  numero      String
  subtotal    Int
  descuento   Int      @default(0)
  costoEnvio  Int
  total       Int
  estado      String @default("pendiente")
  metodoEnvio String @default("desconocido")
  metodoPago String?   @default("MERCADOPAGO")
  expiresAt  DateTime?
  publicToken String?  @unique

  cuponCodigo      String?
  cuponDescuento   Float?   @default(0)

  mercadopagoUrl String?
  
  transferProofStatus String?   // "none" | "sent"
  transferProofNote   String?
  transferProofUrl    String?
  transferProofSentAt DateTime?

  carrier        String?   // "CORREO_ARGENTINO" | "ANDREANI"
  carrierService String?   // opcional: "STANDARD", "SUCURSAL", etc.
  sucursalId     String?
  sucursalNombre String?

  trackingNumber   String?
  trackingUrl    String?
  labelUrl       String?   // URL al PDF del r贸tulo (ideal)
  shippedAt      DateTime? // cu谩ndo lo marcaste como enviado

  adminSeenAt DateTime?
  customerEmailSentAt DateTime?
  confirmedEmailSentAt DateTime?


  //  Relaci贸n con el usuario (opcional)
  userId Int?
  user   User? @relation(fields: [userId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  items PedidoItem[]

  //  CAMPOS DE CHECKOUT Y ENVO
  nombreCliente   String?
  apellidoCliente String?
  emailCliente    String?
  telefonoCliente String?
  dniCliente      String?

  tipoEntrega    String?
  direccion      String?
  ciudad         String?
  localidad      String?
  provincia      String?
  codigoPostal   String?
  sucursalCorreo String?

  notasCliente       String?
  fechaEstimadaEnvio DateTime?
}

model PedidoItem {
  id             Int    @id @default(autoincrement())
  pedidoId       Int
  productoId     Int?
  nombreProducto String
  cantidad       Int
  subtotal       Int

  pedido   Pedido    @relation(fields: [pedidoId], references: [id])
  producto Producto? @relation(fields: [productoId], references: [id])
}

model Cupon {
  id               Int      @id @default(autoincrement())
  codigo           String   @unique
  descripcion      String?
  tipo             TipoCupon // PORCENTAJE o MONTO_FIJO
  valor            Float
  montoMinimo      Float?
  limiteUsos       Int?
  usos             Int      @default(0)
  activo           Boolean  @default(true)
  fechaVencimiento DateTime?
  createdAt        DateTime @default(now())
}

enum TipoCupon {
  PORCENTAJE
  MONTO_FIJO
}